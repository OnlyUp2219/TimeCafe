digraph login_refresh_flow {
  rankdir=TB;
  node [shape=rectangle, width=1, height=0.5, fixedsize=true, fontname="GOST Type A,Arial", fontsize=10];
  /* Узлы LOGIN */
  LOGIN   [label="UI\nЛогин"];
  POSTL   [label="POST /login"];
  CHKCRED [shape=diamond, label="Email +\nпароль OK?"];
  ERRBAD  [label="400\nBad Request"];
  GENTKN  [label="Генерация\nтокенов"];
  OKLOGIN [label="200\nTokens"];
  
  /* Узлы REFRESH */
  CLNT    [label="Клиент\nAccess истек"];
  POSTR   [label="POST /refresh"];
  CHKRF   [shape=diamond, label="Refresh\nвалиден?"];
  ERR401  [label="401\nUnauthorized"];
  NEWTKN  [label="Новые\nтокены"];
  OKREFRSH [label="200\nNew Tokens"];

  /* Ряды для змейки */
  { rank=same; LOGIN; POSTL }
  { rank=same; CHKCRED; ERRBAD }
  { rank=same; GENTKN; OKLOGIN }
  { rank=same; CLNT; POSTR }
  { rank=same; CHKRF; ERR401 }
  { rank=same; NEWTKN; OKREFRSH }

  /* Логический поток LOGIN */
  LOGIN -> POSTL -> CHKCRED;
  CHKCRED -> ERRBAD [label="Нет"];
  CHKCRED -> GENTKN [label="Да"];
  GENTKN -> OKLOGIN;
  
  /* Логический поток REFRESH */
  OKLOGIN -> CLNT;
  CLNT -> POSTR -> CHKRF;
  CHKRF -> ERR401 [label="Нет"];
  CHKRF -> NEWTKN [label="Да"];
  NEWTKN -> OKREFRSH;

  /* Невидимые связи для змейки */
  POSTL -> GENTKN [style=invis, weight=1];
  ERRBAD -> GENTKN [style=invis, weight=1];
  OKLOGIN -> CHKRF [style=invis, weight=1];
  POSTR -> NEWTKN [style=invis, weight=1];
  ERR401 -> NEWTKN [style=invis, weight=1];
}
