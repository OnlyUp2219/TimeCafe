digraph register_flow {
  rankdir=TB;
  node [shape=rectangle, width=1, height=0.5, fixedsize=true, fontname="GOST Type A,Arial", fontsize=10];
  /* Узлы */
  UI   [label="UI\nРегистрация"];
  REG  [label="POST /register"];
  VALID [shape=diamond, label="Валидация\nданных?"]; 
  ERR_VALID  [label="400\nBad Request"];
  CREATE [label="Создать\nучет + хеш"];
  DEC  [shape=diamond, label="Успех\nсоздания?"]; 
  ERR_EXIST  [label="400\nОшибки"];
  SAVE [label="Сохранить\nБД"];
  TOKENS [label="Выдать\nтокены"];
  OK [label="200\nTokens"];

  /* Ряды для змейки (чередование позиций) */
  { rank=same; UI; REG }
  { rank=same; VALID; ERR_VALID }
  { rank=same; CREATE; DEC }
  { rank=same; ERR_EXIST; SAVE }
  { rank=same; TOKENS; OK }

  /* Логический поток */
  UI -> REG -> VALID;
  VALID -> ERR_VALID [label="Нет"];
  VALID -> CREATE [label="Да"];
  CREATE -> DEC;
  DEC -> ERR_EXIST [label="Нет"];
  DEC -> SAVE [label="Да"];
  SAVE -> TOKENS -> OK;

  /* Невидимые связи для формирования змейки */
  REG -> ERR_VALID [style=invis, weight=1];
  ERR_VALID -> CREATE [style=invis, weight=1];
  CREATE -> ERR_EXIST [style=invis, weight=1];
  ERR_EXIST -> TOKENS [style=invis, weight=1];
}
